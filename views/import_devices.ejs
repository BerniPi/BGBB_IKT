<%- include('partials/header') %>
<%- include('partials/navbar', { page }) %>

<div class="container py-4">
  <div class="card shadow-sm">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-file-earmark-excel me-2"></i> Ger채te-Import</h5>
    </div>
    <div class="card-body">
      <p class="text-muted">W채hle deine Excel-Datei und starte den Import. (Nur f체r eingeloggte Nutzer.)</p>

      <!-- 1) WICHTIG: Form-ID vergeben -->
      <form id="importForm" action="/api/devices/import" method="post" enctype="multipart/form-data" class="mt-3">
        <div class="mb-3">
          <label class="form-label">Excel-Datei (.xlsx)</label>
          <input type="file" name="file" accept=".xlsx,.xls" class="form-control" required>
        </div>
        <button class="btn btn-primary"><i class="bi bi-upload me-1"></i> Import starten</button>
        <a href="/devices" class="btn btn-secondary ms-2">Abbrechen</a>
      </form>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<!-- 2) Script: Upload per fetch() + Authorization-Header -->
<script>
(() => {
  const form = document.getElementById('importForm');
  if (!form) return;

  form.addEventListener('submit', async (e) => {
    e.preventDefault(); // normalen Submit stoppen

    const fileInput = form.querySelector('input[type="file"]');
    const file = fileInput?.files?.[0];
    if (!file) { alert('Bitte eine Excel-Datei ausw채hlen.'); return; }

    // Dein JWT aus dem Login-Flow (du speicherst es nach /api/login in localStorage)
    const token = localStorage.getItem('jwtToken');
    if (!token) { alert('Kein Login-Token gefunden. Bitte zuerst einloggen.'); return; }

    // FormData bauen (wie Browser-Upload)
    const fd = new FormData();
    fd.append('file', file);

    try {
      const res = await fetch('/api/devices/import', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token }, // <-- HIER passiert die Magie
        body: fd
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || ('HTTP ' + res.status));
      }

      // Der Server rendert eine HTML-Ergebnisseite (EJS).
      // Wir ersetzen die aktuelle Seite mit der Response:
      const html = await res.text();
      document.open(); document.write(html); document.close();

    } catch (err) {
      alert('Import fehlgeschlagen: ' + (err.message || 'Unbekannter Fehler'));
    }
  });
})();
</script>
