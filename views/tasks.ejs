<%- include('partials/header') %>
<%- include('partials/navbar', { page }) %>

<div class="container-fluid mt-4">
    <div class="card m-2">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5>Aufgabenliste</h5>
                 <button class="btn btn-primary" id="newTaskBtn">
                    <i class="bi bi-plus-circle"></i> Neue Aufgabe

              </button>
            </div>
        </div>
        <div class="card-body">
            <style>
                
            </style>

            <div class="row g-2 mb-3 align-items-end" id="task-filters">
                <div class="col-md-3"><label class="form-label">Status</label>
                    <select id="filter-status" class="form-select">
                        <option value="active" selected>Alle Aktiven (Offen, In Arbeit)</option>
                        <option value="">Alle (inkl. Erledigt)</option>
                        <option value="open">Nur Offen</option>
                        <option value="in_progress">Nur In Arbeit</option>
                        <option value="done">Erledigt</option>
                        <option value="canceled">Abgebrochen</option>
                    </select>
                </div>
                <div class="col-md-3"><label class="form-label">Priorität</label><select id="filter-priority" class="form-select"><option value="">Alle</option><option value="low">Niedrig</option><option value="normal">Normal</option><option value="high">Hoch</option><option value="urgent">Dringend</option></select></div>
<div class="col-md-6"><label
class="form-label">Volltextsuche</label><input type="search" id="filter-q" class="form-control" placeholder="Aufgabe, Notiz, Person..."></div>
            </div>
            <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th class="sortable-header sort-desc" data-sort="date">Datum</th>
                        <th class="sortable-header" data-sort="status">Status</th>
                        <th class="sortable-header" data-sort="priority">Priorität</th>
                        <th class="sortable-header" data-sort="category">Kategorie</th>
                        <th class="sortable-header" data-sort="task">Aufgabe / Notizen</th>
                        <th class="sortable-header" data-sort="room_name">Raum</th>
                        <th class="sortable-header" data-sort="assigned_to">Zugewiesen</th>
                        <th style="width: 120px;">Aktion</th>
                    </tr>
                </thead>
                    <tbody id="tasks-table-body">

    </tbody>
                </table>

      </div>
        </div>
    </div>
</div>

<div class="card m-2">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="bi bi-calendar-check me-2"></i> Automatisch fällige Kontrollen
            <span id="maintenance-task-count" class="badge bg-warning text-dark ms-1">0</span>
        </h5>
    </div>
    <div class="card-body">
        <p class="text-muted small">
            Diese Liste zeigt alle Geräte an, bei denen das "Zuletzt kontrolliert"-Datum
            älter als das am Modell hinterlegte Wartungsintervall ist (oder bei denen noch nie eine Kontrolle erfasst wurde).
        </p>
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th class="sortable-header" data-sort="device">Gerät (Hostname/SN)</th>
                        <th class="sortable-header" data-sort="model">Modell</th>
                        <th class="sortable-header" data-sort="room">Raum</th>
                        <th class="sortable-header sort-asc" data-sort="last_inspected">Zuletzt kontrolliert</th>
                        <th class="sortable-header" data-sort="interval">Intervall</th>
                        <th class="sortable-header" data-sort="due_date">Fälligkeit</th> <th>Aktion</th>
                    </tr>
                </thead>
                <tbody id="maintenance-tasks-table-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="taskForm">
                <div class="modal-header">

       <h5 class="modal-title" id="taskModalTitle">Aufgabe</h5>

         <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="taskId">
                    <div class="row g-3">

             <div class="col-md-4"><label class="form-label">Datum*</label><input type="date" id="task-date" class="form-control" required></div>
                        <div class="col-md-8"><label class="form-label">Aufgabe / Titel*</label><input type="text" id="task-task" class="form-control" required></div>
                        <div class="col-md-4"><label class="form-label">Kategorie*</label><select id="task-category" class="form-select" required><option>Hardware</option><option>Software</option><option>Allgemein</option><option>Bestellung</option><option>Inventar</option><option>Laptops</option><option>Problem</option><option>Test</option><option>Switch</option><option>WLAN</option></select></div>

    <div class="col-md-4"><label class="form-label">Priorität</label><select id="task-priority" class="form-select"><option value="low">Niedrig</option><option selected value="normal">Normal</option><option value="high">Hoch</option><option value="urgent">Dringend</option></select></div>
                        <div class="col-md-4"><label class="form-label">Status</label><select id="task-status" class="form-select"><option value="open">Offen</option><option value="in_progress">In Arbeit</option><option value="done">Erledigt</option><option value="canceled">Abgebrochen</option></select></div>
                        <div class="col-md-4"><label class="form-label">Gemeldet von</label><input type="text" id="task-reported_by" class="form-control"></div>

<div class="col-md-4"><label class="form-label">Zugewiesen an</label><input type="text" id="task-assigned_to" class="form-control"></div>
                         <div class="col-md-4"><label class="form-label">Raum (optional)</label><select id="task-room_id" class="form-select"><option value="">Kein Raum</option></select></div>
                        <div class="col-12"><label class="form-label">Notizen / Beschreibung</label><textarea id="task-notes" class="form-control" rows="3"></textarea></div>
                        <div class="col-md-6"><label class="form-label">Erledigt am</label><input type="date" id="task-completed_at" class="form-control"></div>

                       <div class="col-md-6"><label class="form-label">Erledigt von</label><input type="text" id="task-completed_by" class="form-control"></div>
                    </div>
                </div>
                <div class="modal-footer">

  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="completeTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form
id="completeTaskForm">
                <div class="modal-header">
                    <h5 class="modal-title">Aufgabe abschließen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">

               <input type="hidden" id="complete-task-id">
                    <input type="hidden" id="complete-task-room-id">
                    <input type="hidden" id="complete-task-title">
                    <input type="hidden" id="complete-task-id">

   <input type="hidden" id="complete-task-notes">

                    <p>Wählen Sie die Geräte aus, die bei dieser Aufgabe beteiligt waren.</p>

                    <div id="complete-task-device-list" class="mb-3 p-2 border
rounded" style="max-height: 200px; overflow-y: auto;">
                        <span class="text-muted">Geräte werden geladen...</span>
                    </div>

                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" role="switch" id="complete-task-create-maintenance">

                     <label class="form-check-label" for="complete-task-create-maintenance">
                        Wartungseintrag für ausgewählte Geräte erstellen?
                      </label>
                    </div>

         </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-success">Aufgabe abschließen</button>
                </div>

  </form>
        </div>
    </div>
</div>

<%- include('partials/footer') %>
<script src="/js/tasks.js"></script>
