<%- include('partials/header') %>
<%- include('partials/navbar', { page: 'walkthrough' }) %>

<div class="container-fluid mt-4">
  <div class="card shadow-sm">
<div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-person-walking me-2"></i> Walkthrough</h5>

      <button class="btn btn-primary" id="walkthrough-new-device">
        <i class="bi bi-plus-lg me-1"></i> Neues Gerät
      </button>
    </div>

    <div class="card-body border-bottom p-3">
      <div class="row g-2 align-items-center">

        <div class="col-md-4">
          <label for="walkthrough-floor-select" class="form-label small">Stockwerk</label>
 
         <select id="walkthrough-floor-select" class="form-select form-select-lg">
            <option value="">Bitte Stockwerk wählen...</option>
          </select>
        </div>

        <div class="col-md-8">
          <label for="walkthrough-room-select" class="form-label small">Raum</label>
          <div class="input-group input-group-lg">
            <button class="btn btn-outline-secondary" id="btn-prev-room" title="Vorheriger Raum" disabled>
   
           <i class="bi bi-arrow-left"></i>
            </button>
            <select id="walkthrough-room-select" class="form-select">
              <option value="">Lade Räume...</option>
            </select>
            <button class="btn btn-outline-secondary" id="btn-next-room" title="Nächster Raum" disabled>
              <i 
class="bi bi-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <h4 id="current-room-name" class="mb-0"></h4>
        <button class="btn btn-success" id="btn-mark-inspected-today" title="Alle Geräte in diesem Raum: 'heute inspiziert'">
          <i class="bi bi-calendar-check me-1"></i> Alle inspiziert (heute)
        </button>
 
     </div>
    </div>

   <div class="card-body">
      <div class="row g-2 mb-3 align-items-end">
          <div class="col-md-6">
              <h6><span id="walkthrough-devices-body-title">Geräte in diesem Raum</span> (<span id="walkthrough-device-count">0</span>)</h6>
          </div>
          <div class="col-md-6">
              <label for="walkthrough-find-inventory" class="form-label small fw-bold">Gerät global suchen</label>
     
         <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                  <input type="text" id="walkthrough-find-inventory" class="form-control" placeholder="Global nach Inventar, Serie, Modell suchen...">
                  <button class="btn btn-outline-secondary" id="walkthrough-find-clear-btn" type="button" title="Suche löschen"><i class="bi bi-x-lg"></i></button>
     <%#           
 <button class="btn btn-outline-primary" id="walkthrough-scan-btn" type="button" title="Kamera-Scan starten">
                      <i class="bi bi-camera-video"></i>
                  </button> %>
              </div>
          </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
  
        <thead>
            <tr>
              <th class="sortable-header" data-sort="category_name">Kategorie</th>
              <th class="sortable-header" data-sort="model_name">Modell</th>
              <th class="sortable-header" data-sort="hostname">Hostname</th>
              <th class="sortable-header" data-sort="serial_number">Seriennummer</th>
              <th class="sortable-header" 
data-sort="inventory_number">Inventarnummer</th>
              <th class="sortable-header" data-sort="mac_address">MAC-Adresse</th>
              <th class="sortable-header" data-sort="ip_address">IP-Adresse</th>
              <th class="sortable-header" data-sort="status">Status</th>
              <th>Notizen</th>
              <th style="width:120px;">Aktion</th>
            </tr>
          </thead>
 
         <tbody id="walkthrough-devices-body">
            </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deviceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable modal-fullscreen-sm-down">
    <div class="modal-content">
      <form id="deviceForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i> Gerät bearbeiten</h5>
          
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>

        <div class="modal-body pb-3">
          <input type="hidden" id="device-device_id">

          <div class="row g-3">
            <div class="col-md-4">
              <label for="device-model_id" class="form-label">Modell</label>
              <select id="device-model_id" class="form-select">
         
       </select>
            </div>

            <div class="col-md-4">
              <label for="device-hostname" class="form-label">Kurzname/Netzwerkname</label>
              <input type="text" id="device-hostname" class="form-control">
            </div>

            <div class="col-md-4">
          
    <label for="device-status" class="form-label">Status</label>
              <select id="device-status" class="form-select">
                <option value="active">Aktiv</option>
                <option value="storage">Lager</option>
                <option value="defective">Defekt</option>
                <option value="decommissioned">Ausgeschieden</option>
          
    </select>
            </div>
            <div class="col-md-6">
          
    <label for="device-serial_number" class="form-label">Seriennummer</label>
              <input type="text" id="device-serial_number" class="form-control">
            </div>
            <div class="col-md-6">
             
 <label for="device-inventory_number" class="form-label">Inventarnummer</label>
              <input type="text" id="device-inventory_number" class="form-control">
            </div>

            <div id="network-fields" class="row g-3 d-none">
              <div class="col-md-6">
                <label for="device-mac_address" class="form-label">MAC-Adresse</label>
                <input type="text" id="device-mac_address" 
class="form-control" placeholder="z. B. AA:BB:CC:DD:EE:FF">
              </div>
              <div class="col-md-6">
                <label for="device-ip_address" class="form-label">IP-Adresse</label>
                <input type="text" id="device-ip_address" class="form-control" placeholder="z.
B. 192.168.1.10">
              </div>
            </div>

            <div class="col-md-3">
              <label for="device-purchase_date" class="form-label">Kaufdatum</label>
              <input type="date" id="device-purchase_date" class="form-control">
            </div>
            <div class="col-md-3">
  
            <label for="device-price" class="form-label">Kaufpreis (€)</label>
              <input type="number" step="0.01" min="0" id="device-price" class="form-control" placeholder="z.
B. 1499.99">
            </div>
            <div class="col-md-3">
              <label for="device-warranty_months" class="form-label">Garantie (Monate)</label>
              <input type="number" min="0" id="device-warranty_months" class="form-control" placeholder="z.
B. 24">
            </div>

            <div class="col-md-3">
              <label for="device-added_at" class="form-label">Hinzugefügt am</label>
              <input type="date" id="device-added_at" class="form-control">
            </div>
            <div class="col-md-3">
              <label 
for="device-decommissioned_at" class="form-label">Ausgeschieden am</label>
              <input type="date" id="device-decommissioned_at" class="form-control">
            </div>
            <div class="col-md-3">
              <label for="device-last_cleaned" class="form-label">Zuletzt gereinigt</label>
              <input type="date" id="device-last_cleaned" class="form-control">
            </div>
          
  <div class="col-md-3">
              <label for="device-last_inspected" class="form-label">Zuletzt kontrolliert</label>
              <input type="date" id="device-last_inspected" class="form-control">
            </div>

            <div class="col-12">
              <label for="device-notes" class="form-label">Notizen</label>
              <textarea id="device-notes" rows="2" class="form-control" placeholder="Freitext …"></textarea>
   
         </div>
          </div>

          <hr class="my-3">

          <h6 class="mb-2">Raum-Historie</h6>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
   
               <th style="width:22%">Von</th>
                  <th style="width:22%">Bis</th>
                  <th style="width:36%">Raum</th>
                  <th style="width:12%">Notizen</th>
                  <th style="width:8%"></th>
        
        </tr>
              </thead>
              <tbody id="room-history-body">
                </tbody>
              <tfoot>
                <tr>
                 
 <td><input type="date" id="rh-from" class="form-control"></td>
                  <td><input type="date" id="rh-to" class="form-control" placeholder="leer = offen"></td>
                  <td><select id="rh-room" class="form-select"></select></td>
                  <td><input type="text" id="rh-notes" class="form-control" placeholder="Notizen"></td>
                  <td class="text-end">
           
         <button type="button" class="btn btn-sm btn-primary" id="rh-add">
                      <i class="bi bi-plus-lg"></i>
                    </button>
                  </td>
                </tr>
        
      </tfoot>
            </table>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1"></i> Speichern
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
  
      </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="maintenanceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="maintenanceForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-tools me-2"></i> Neuer Wartungseintrag</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>
        <div class="modal-body">

     
     <input type="hidden" id="maint-device_id">

          <p>Für Gerät: <strong id="maint-device-info">...</strong></p>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="maint-event_date" class="form-label">Datum*</label>
              <input type="date" class="form-control" id="maint-event_date" required>
            </div>
         
   <div class="col-md-6">
              <label for="maint-event_type" class="form-label">Typ*</label>
              <select class="form-select" id="maint-event_type" required>
                {/* Optionen basierend auf DB-Schema */}
                <option value="inspection">Inspektion</option>
                <option value="cleaning">Reinigung</option>
        
        <option value="repair">Reparatur</option>
                <option value="upgrade">Upgrade</option>
                <option value="config">Konfiguration</option>
                <option value="other">Andere</option>
              </select>
            </div>
            <div class="col-12">
 
             <label for="maint-title" class="form-label">Titel*</label>
              <input type="text" class="form-control" id="maint-title" required placeholder="z.B.
Jährliche Inspektion">
            </div>
            <div class="col-12">
              <label for="maint-description" class="form-label">Beschreibung</label>
              <textarea class="form-control" id="maint-description" rows="3"></textarea>
            </div>
             <div class="col-md-6">
              <label 
for="maint-performed_by" class="form-label">Durchgeführt von</label>
              <input type="text" class="form-control" id="maint-performed_by" placeholder="z.B.
Admin">
            </div>


          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1"></i> Eintrag speichern
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
       
 </div>
      </form>
    </div>
  </div>
</div>


<div class="modal fade" id="scannerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Barcode scannen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">Richte die Kamera auf den Barcode des Geräts.</p>
        <div id="scanner-viewport" style="width: 100%;"></div>
      
</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="moveDeviceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="moveDeviceForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-arrows-move me-2"></i> Gerät verschieben</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        
</div>
        <div class="modal-body">
          <input type="hidden" id="move-device-id">
          <input type="hidden" id="move-target-room-id">

          <p>Gerät: <strong id="move-device-info">...</strong></p>
          <p>Neuer Raum: <strong id="move-target-room-info" class="text-success">...</strong></p>
          
          <hr>

          <div class="row g-3 align-items-end">
        
    <div class="col-md-5">
              <label class="form-label">Aktion</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="moveAction" id="move-action-new" value="new" checked>
                <label class="form-check-label" for="move-action-new">
                  Neuen Historieneintrag erstellen
     
           </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="moveAction" id="move-action-correct" value="correct">
                <label class="form-check-label" for="move-action-correct">
                  Letzten Eintrag korrigieren
 
               </label>
              </div>
            </div>
            
            <div class="col-md-7">
              <label for="move-date" class="form-label">Gültig ab Datum (für 'Neuen Eintrag')</label>
             
 <input type="date" id="move-date" class="form-control" list="recent-move-dates">
               <datalist id="recent-move-dates"></datalist>
            </div>
          </div>
          
          <hr>

          <h6 class="mb-2">Bisherige Raum-Historie</h6>
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
  
              <tr>
                  <th>Von</th>
                  <th>Bis</th>
                  <th>Raum</th>
                </tr>
              </thead>
  
            <tbody id="move-history-body">
                </tbody>
            </table>
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1"></i> Verschiebung speichern
  
        </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script src="/js/devices.js"></script>
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script src="/js/walkthrough.js"></script>