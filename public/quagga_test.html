<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuaggaJS Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 20px;
      }
      /* 2. Viewport für die Kamera (wichtig!) */
      #scanner-viewport {
        position: relative;
        width: 100%;
        max-width: 640px;
        height: 480px;
        overflow: hidden;
        border: 2px solid lightgray;
        margin: 20px auto;
      }
      /* Quagga zeichnet Canvas-Elemente in den Viewport */
      #scanner-viewport canvas,
      #scanner-viewport video {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
      }
      /* Visuelles Feedback (grüne Boxen) */
      .drawingBuffer {
        position: absolute;
        top: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <h1>QuaggaJS Barcode-Scanner Test</h1>
    <p>
      Richte die Kamera auf einen <strong>1D-Barcode</strong> (z.B. Code 128, EAN).
    </p>

    <button id="btn-start">Scanner starten</button>
    <button id="btn-stop" disabled>Scanner stoppen</button>

    <div id="scanner-viewport"></div>

    <h3>Ergebnis:</h3>
    <pre><code id="scan-result">...</code></pre>

    <script>
      const startButton = document.getElementById("btn-start");
      const stopButton = document.getElementById("btn-stop");
      const resultEl = document.getElementById("scan-result");

      startButton.addEventListener("click", startScanner);
      stopButton.addEventListener("click", stopScanner);

      let isScannerRunning = false;

      function startScanner() {
        Quagga.init(
          {
            inputStream: {
              name: "Live",
              type: "LiveStream",
              target: document.querySelector("#scanner-viewport"), // Dein Viewport-Div
              constraints: {
                width: 640,
                height: 480,
                facingMode: "environment", // Rückkamera
              },
            },
            decoder: {
              // Hier die Barcode-Typen angeben, die du brauchst
              readers: [
                "code_128_reader",
                "ean_reader",
                "code_39_reader",
                "codabar_reader",
                "upc_reader",
              ],
            },
            locate: true, // Versucht, den Barcode im Bild zu finden
          },
          function (err) {
            if (err) {
              resultEl.textContent = `Fehler beim Initialisieren: ${err}`;
              console.error(err);
              return;
            }
            resultEl.textContent = "Scanner initialisiert. Starte...";
            Quagga.start();
            isScannerRunning = true;
            updateButtonStates();
          },
        );
      }

      function stopScanner() {
        if (isScannerRunning) {
          Quagga.stop();
          isScannerRunning = false;
          resultEl.textContent = "Scanner gestoppt.";
          updateButtonStates();
        }
      }

      function updateButtonStates() {
        startButton.disabled = isScannerRunning;
        stopButton.disabled = !isScannerRunning;
      }

      // 4. Listener für erfolgreichen Scan
      Quagga.onDetected(function (result) {
        const code = result.codeResult.code;
        resultEl.textContent = `CODE GEFUNDEN: ${code}`;
        console.log("Scan-Ergebnis:", result);

        // Scanner stoppen, sobald etwas gefunden wurde
        stopScanner();
      });

      // 5. (Optional) Visuelles Feedback, während gescannt wird
      Quagga.onProcessed(function (result) {
        const drawingCtx = Quagga.canvas.ctx.overlay;
        const drawingCanvas = Quagga.canvas.dom.overlay;

        drawingCtx.clearRect(
          0,
          0,
          parseInt(drawingCanvas.getAttribute("width")),
          parseInt(drawingCanvas.getAttribute("height")),
        );

        if (result) {
          if (result.boxes) {
            result.boxes
              .filter(function (box) {
                return box !== result.box;
              })
              .forEach(function (box) {
                Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, {
                  color: "green",
                  lineWidth: 2,
                });
              });
          }

          if (result.box) {
            Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, {
              color: "#00F",
              lineWidth: 2,
            });
          }

          if (result.codeResult && result.codeResult.code) {
            Quagga.ImageDebug.drawPath(
              result.line,
              { x: "x", y: "y" },
              drawingCtx,
              { color: "red", lineWidth: 3 },
            );
          }
        }
      });
    </script>
  </body>
</html>