<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventardatenbank</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Inventar DB</a>
            <button class="btn btn-outline-light" id="logoutBtn">Abmelden</button>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices-tab-pane" type="button" role="tab">Geräte</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks-tab-pane" type="button" role="tab">✅ To-Do / Aufgaben</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance-tab-pane" type="button" role="tab">Wartung</button>
            </li>
             <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-tab-pane" type="button" role="tab">⚙️ Stammdaten</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade" id="devices-tab-pane" role="tabpanel" tabindex="0">
                <div class="p-3">
                    <h3>Geräteübersicht</h3>
                    <div id="device-list" class="table-responsive"></div>
                </div>
            </div>

            <div class="tab-pane fade show active" id="tasks-tab-pane" role="tabpanel" tabindex="0">
                <div class="card m-2">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>Aufgabenliste</h5>
                             <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="prepareNewTaskModal()">
                                <i class="bi bi-plus-circle"></i> Neue Aufgabe
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3 align-items-end" id="task-filters">
                            <div class="col-md-2"><label class="form-label">Status</label><select id="filter-status" class="form-select"><option value="">Alle</option><option value="open">Offen</option><option value="in_progress">In Arbeit</option><option value="done">Erledigt</option><option value="canceled">Abgebrochen</option></select></div>
                            <div class="col-md-2"><label class="form-label">Priorität</label><select id="filter-priority" class="form-select"><option value="">Alle</option><option value="low">Niedrig</option><option value="normal">Normal</option><option value="high">Hoch</option><option value="urgent">Dringend</option></select></div>
                            <div class="col-md-2"><label class="form-label">Kategorie</label><select id="filter-category" class="form-select"><option value="">Alle</option><option>Hardware</option><option>Software</option><option>Allgemein</option><option>Bestellung</option><option>Inventar</option><option>Laptops</option><option>Problem</option><option>Test</option><option>Switch</option><option>WLAN</option></select></div>
                            <div class="col-md-4"><label class="form-label">Volltextsuche</label><input type="search" id="filter-q" class="form-control" placeholder="Aufgabe, Notiz, Person..."></div>
                            <div class="col-md-2"><button class="btn btn-secondary w-100" onclick="loadTasks()">Filter anwenden</button></div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Datum</th><th>Status</th><th>Priorität</th><th>Kategorie</th><th>Aufgabe</th><th>Raum</th><th>Zugewiesen</th><th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody id="tasks-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

<div class="tab-pane fade" id="maintenance-tab-pane" role="tabpanel" tabindex="0">
    <div class="card m-2">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5>Wartung / Änderungen</h5>
                <div class="d-flex align-items-center">
                    <a href="/api/export/maintenance" class="btn btn-outline-success me-3" target="_blank">
                        <i class="bi bi-file-earmark-excel"></i> Exportieren
                    </a>
                    <button id="new-maintenance-btn" class="btn btn-primary" disabled>
                        <i class="bi bi-plus-circle"></i> Neuer Eintrag
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="maintenance-device-select" class="form-label"><b>Gerät auswählen</b>, um Einträge anzuzeigen und zu verwalten:</label>
                <select class="form-select" id="maintenance-device-select">
                    <option selected disabled>Bitte zuerst ein Gerät wählen...</option>
                </select>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Typ</th>
                            <th>Titel</th>
                            <th>Status</th>
                            <th>Durchgeführt von</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="maintenance-table-body">
                        <tr><td colspan="6" class="text-center text-muted">Kein Gerät ausgewählt.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="maintenanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="maintenanceForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="maintenanceModalTitle">Wartungseintrag</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="maintenanceId">
                    <input type="hidden" id="maintenanceDeviceId">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Datum*</label>
                            <input type="date" id="maintenance-event_date" class="form-control" required>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Titel*</label>
                            <input type="text" id="maintenance-title" class="form-control" placeholder="z.B. RAM aufgerüstet" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Typ*</label>
                            <select id="maintenance-event_type" class="form-select" required>
                                <option value="repair">Reparatur</option>
                                <option value="upgrade">Upgrade</option>
                                <option value="config">Konfiguration</option>
                                <option value="cleaning">Reinigung</option>
                                <option value="inspection">Inspektion</option>
                                <option value="other">Sonstiges</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select id="maintenance-status" class="form-select">
                                <option value="done">Erledigt</option>
                                <option value="planned">Geplant</option>
                                <option value="in_progress">In Arbeit</option>
                                <option value="canceled">Abgebrochen</option>
                            </select>
                        </div>
                         <div class="col-md-4">
                            <label class="form-label">Durchgeführt von</label>
                            <input type="text" id="maintenance-performed_by" class="form-control">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Beschreibung / Details</label>
                            <textarea id="maintenance-description" class="form-control" rows="3"></textarea>
                        </div>
                         <div class="col-md-4">
                            <label class="form-label">Dauer (Minuten)</label>
                            <input type="number" id="maintenance-duration_minutes" class="form-control">
                        </div>
                         <div class="col-md-4">
                            <label class="form-label">Kosten (in Cent)</label>
                            <input type="number" id="maintenance-cost_cents" class="form-control">
                        </div>
                         <div class="col-md-4">
                            <label class="form-label">Nächste Fälligkeit</label>
                            <input type="date" id="maintenance-next_due_date" class="form-control">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notizen</label>
                            <textarea id="maintenance-notes" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>
</div>           
<div class="tab-pane fade" id="settings-tab-pane" role="tabpanel" tabindex="0">
    <div class="p-3">
        <h3>Stammdaten verwalten</h3>
        <p class="text-muted">Hier können die grundlegenden Daten der Anwendung wie Räume, Gerätemodelle und Kategorien verwaltet werden.</p>
        
        <div class="accordion" id="settingsAccordion">

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingRooms">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRooms">
                        <i class="bi bi-door-open-fill me-2"></i> Räume
                    </button>
                </h2>
                <div id="collapseRooms" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <form id="roomForm" class="row g-3 mb-4 p-3 border rounded bg-light">
                            <input type="hidden" id="room-room_id">
                            <div class="col-md-2"><input type="text" class="form-control" id="room-room_number" placeholder="Raumnummer*" required></div>
                            <div class="col-md-4"><input type="text" class="form-control" id="room-room_name" placeholder="Raumname*" required></div>
                            <div class="col-md-2"><input type="number" class="form-control" id="room-floor" placeholder="Etage"></div>
                            <div class="col-md-2"><input type="number" class="form-control" id="room-sort_order" placeholder="Sortierung"></div>
                            <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Speichern</button></div>
                        </form>
<div class="table-responsive">
  <table class="table table-sm" id="roomTable">
    <thead class="table-light">
      <tr>
        <th style="width: 10%;">Sortierung</th> <th>Nr.</th>
        <th>Name</th>
        <th>Stockwerk</th>
        <th style="width: 15%;">Aktionen</th> </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
                    </div>
                </div>
            </div>
            
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingModels">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseModels">
                        <i class="bi bi-laptop me-2"></i> Gerätemodelle
                    </button>
                </h2>
                <div id="collapseModels" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead><tr><th>Kategorie</th><th>Typ</th><th>Modellnummer</th><th>Aktion</th></tr></thead>
                                <tbody id="models-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingDeviceCats">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDeviceCats">
                         <i class="bi bi-tags-fill me-2"></i> Gerätekategorien
                    </button>
                </h2>
                <div id="collapseDeviceCats" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                         <form id="deviceCategoryForm" class="row g-3 mb-4 p-3 border rounded bg-light">
                            <input type="hidden" id="cat-category_id">
                            <div class="col-md-5"><input type="text" class="form-control" id="cat-category_name" placeholder="Name der Kategorie*" required></div>
                            <div class="col-md-5"><input type="text" class="form-control" id="cat-description" placeholder="Beschreibung"></div>
                            <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Speichern</button></div>
                        </form>
                        <div class="table-responsive">
                            <table class="table">
                                <thead><tr><th>Name</th><th>Beschreibung</th><th>Aktion</th></tr></thead>
                                <tbody id="device-categories-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            </div>
    </div>
</div>
        </div>
    </div>
    
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="taskForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="taskModalTitle">Aufgabe</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="taskId">
                        <div class="row g-3">
                            <div class="col-md-4"><label class="form-label">Datum*</label><input type="date" id="task-date" class="form-control" required></div>
                            <div class="col-md-8"><label class="form-label">Aufgabe / Titel*</label><input type="text" id="task-task" class="form-control" required></div>
                            <div class="col-md-4"><label class="form-label">Kategorie*</label><select id="task-category" class="form-select" required><option>Hardware</option><option>Software</option><option>Allgemein</option><option>Bestellung</option><option>Inventar</option><option>Laptops</option><option>Problem</option><option>Test</option><option>Switch</option><option>WLAN</option></select></div>
                            <div class="col-md-4"><label class="form-label">Priorität</label><select id="task-priority" class="form-select"><option value="low">Niedrig</option><option selected value="normal">Normal</option><option value="high">Hoch</option><option value="urgent">Dringend</option></select></div>
                            <div class="col-md-4"><label class="form-label">Status</label><select id="task-status" class="form-select"><option value="open">Offen</option><option value="in_progress">In Arbeit</option><option value="done">Erledigt</option><option value="canceled">Abgebrochen</option></select></div>
                            <div class="col-md-4"><label class="form-label">Gemeldet von</label><input type="text" id="task-reported_by" class="form-control"></div>
                            <div class="col-md-4"><label class="form-label">Zugewiesen an</label><input type="text" id="task-assigned_to" class="form-control"></div>
                             <div class="col-md-4"><label class="form-label">Raum (optional)</label><select id="task-room_id" class="form-select"><option value="">Kein Raum</option></select></div>
                            <div class="col-12"><label class="form-label">Notizen / Beschreibung</label><textarea id="task-notes" class="form-control" rows="3"></textarea></div>
                            <div class="col-md-6"><label class="form-label">Erledigt am</label><input type="date" id="task-completed_at" class="form-control"></div>
                            <div class="col-md-6"><label class="form-label">Erledigt von</label><input type="text" id="task-completed_by" class="form-control"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="submit" class="btn btn-primary">Speichern</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Globale Konfiguration & Auth ---
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            window.location.href = '/login';
        }
        const authHeaders = {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('jwtToken');
            window.location.href = '/login';
        });

        // --- Initialisierung ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTasks();
            loadDevices(); // Beispiel für das Laden anderer Daten
            loadRoomsIntoSelects();
        });
        
        // --- Helper: API Fetch ---
        async function apiFetch(url, options = {}) {
            const response = await fetch(url, { headers: authHeaders, ...options });
            if (response.status === 401 || response.status === 403) {
                 window.location.href = '/login';
            }
            if (!response.ok) throw new Error(`API Fehler: ${response.statusText}`);
            return response.json();
        }

        // --- Logik für den TASKS-TAB ---
        const taskStatusBadges = {
            open: '<span class="badge bg-primary">Offen</span>',
            in_progress: '<span class="badge bg-warning text-dark">In Arbeit</span>',
            done: '<span class="badge bg-success">Erledigt</span>',
            canceled: '<span class="badge bg-secondary">Abgebrochen</span>',
        };
        const taskPriorityBadges = {
            low: '<span class="badge bg-info text-dark">Niedrig</span>',
            normal: '<span class="badge bg-light text-dark">Normal</span>',
            high: '<span class="badge bg-danger">Hoch</span>',
            urgent: '<span class="badge bg-danger-subtle text-danger-emphasis">Dringend</span>',
        };
        
        async function loadRoomsIntoSelects() {
            try {
                const rooms = await apiFetch('/api/rooms');
                const select = document.getElementById('task-room_id');
                select.innerHTML = '<option value="">Kein Raum</option>'; // Reset
                rooms.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.room_id;
                    option.textContent = `${room.room_name} (${room.room_number})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Fehler beim Laden der Räume:", error);
            }
        }

        async function loadTasks() {
            const params = new URLSearchParams({
                status: document.getElementById('filter-status').value,
                priority: document.getElementById('filter-priority').value,
                category: document.getElementById('filter-category').value,
                q: document.getElementById('filter-q').value,
            }).toString();
            
            try {
                const tasks = await apiFetch(`/api/tasks?${params}`);
                const tbody = document.getElementById('tasks-table-body');
                tbody.innerHTML = '';
                tasks.forEach(task => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${task.date}</td>
                            <td>${taskStatusBadges[task.status] || task.status}</td>
                            <td>${taskPriorityBadges[task.priority] || task.priority}</td>
                            <td>${task.category}</td>
                            <td>${task.task}<br><small class="text-muted">${task.notes || ''}</small></td>
                            <td>${task.room_name || '-'}</td>
                            <td>${task.assigned_to || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" onclick="editTask(${task.task_id})"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.task_id})"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Fehler beim Laden der Tasks:", error);
            }
        }
        
        function prepareNewTaskModal() {
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            document.getElementById('taskModalTitle').textContent = 'Neue Aufgabe erstellen';
            document.getElementById('task-date').value = new Date().toISOString().split('T')[0];
        }

        async function editTask(id) {
            try {
                const task = await apiFetch(`/api/tasks/${id}`);
                document.getElementById('taskModalTitle').textContent = 'Aufgabe bearbeiten';
                document.getElementById('taskId').value = task.task_id;
                document.getElementById('task-date').value = task.date;
                document.getElementById('task-task').value = task.task;
                document.getElementById('task-category').value = task.category;
                document.getElementById('task-priority').value = task.priority;
                document.getElementById('task-status').value = task.status;
                document.getElementById('task-reported_by').value = task.reported_by;
                document.getElementById('task-assigned_to').value = task.assigned_to;
                document.getElementById('task-room_id').value = task.room_id || '';
                document.getElementById('task-notes').value = task.notes;
                document.getElementById('task-completed_at').value = task.completed_at;
                document.getElementById('task-completed_by').value = task.completed_by;
                new bootstrap.Modal(document.getElementById('taskModal')).show();
            } catch(error) {
                 console.error(`Fehler beim Laden von Task ${id}:`, error);
            }
        }

        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('taskId').value;
            const isUpdate = !!id;
            const url = isUpdate ? `/api/tasks/${id}` : '/api/tasks';
            const method = isUpdate ? 'PUT' : 'POST';

            const body = {
                date: document.getElementById('task-date').value,
                category: document.getElementById('task-category').value,
                task: document.getElementById('task-task').value,
                priority: document.getElementById('task-priority').value,
                status: document.getElementById('task-status').value,
                reported_by: document.getElementById('task-reported_by').value,
                assigned_to: document.getElementById('task-assigned_to').value,
                room_id: document.getElementById('task-room_id').value || null,
                notes: document.getElementById('task-notes').value,
                completed_at: document.getElementById('task-completed_at').value || null,
                completed_by: document.getElementById('task-completed_by').value || null,
            };
            
            try {
                await apiFetch(url, { method, body: JSON.stringify(body) });
                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                loadTasks();
            } catch (error) {
                console.error('Fehler beim Speichern des Tasks:', error);
                alert('Speichern fehlgeschlagen!');
            }
        });

        async function deleteTask(id) {
            if (confirm(`Möchtest du Task #${id} wirklich löschen?`)) {
                 try {
                    await apiFetch(`/api/tasks/${id}`, { method: 'DELETE' });
                    loadTasks();
                } catch (error) {
                    console.error('Fehler beim Löschen des Tasks:', error);
                    alert('Löschen fehlgeschlagen!');
                }
            }
        }

        // --- Logik für andere Tabs (Beispiel) ---
        async function loadDevices() {
             try {
                const devices = await apiFetch('/api/devices');
                const list = document.getElementById('device-list');
                let html = '<table class="table table-sm"><thead><tr><th>Kategorie</th><th>Modell</th><th>S/N</th><th>Inventar-Nr.</th><th>Raum</th></tr></thead><tbody>';
                devices.forEach(d => {
                    html += `<tr><td>${d.category_name}</td><td>${d.type} ${d.model_number}</td><td>${d.serial_number}</td><td>${d.inventory_number}</td><td>${d.room_name || '-'}</td></tr>`;
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (error) {
                console.error("Fehler beim Laden der Geräte:", error);
            }
        }

// --- Initialisierung (Erweiterung) ---
document.addEventListener('DOMContentLoaded', () => {
    // ... bestehender Code (loadTasks, loadDevices, etc.) ...
    loadDevicesForMaintenanceSelect(); // Neue Funktion aufrufen
});


// --- Logik für den MAINTENANCE-TAB ---
const maintenanceStatusBadges = {
    planned: '<span class="badge bg-info text-dark">Geplant</span>',
    in_progress: '<span class="badge bg-warning text-dark">In Arbeit</span>',
    done: '<span class="badge bg-success">Erledigt</span>',
    canceled: '<span class="badge bg-secondary">Abgebrochen</span>',
};

async function loadDevicesForMaintenanceSelect() {
    try {
        const devices = await apiFetch('/api/devices');
        const select = document.getElementById('maintenance-device-select');
        select.innerHTML = '<option selected disabled>Bitte zuerst ein Gerät wählen...</option>'; // Reset
        devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.device_id;
            option.textContent = `[${device.inventory_number || 'N/A'}] ${device.type} ${device.model_number} (S/N: ${device.serial_number})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error("Fehler beim Laden der Geräte für die Auswahl:", error);
    }
}

document.getElementById('maintenance-device-select').addEventListener('change', (e) => {
    const deviceId = e.target.value;
    if (deviceId) {
        document.getElementById('new-maintenance-btn').disabled = false;
        loadMaintenanceForDevice(deviceId);
    }
});

async function loadMaintenanceForDevice(deviceId) {
    const tbody = document.getElementById('maintenance-table-body');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Lade Daten...</td></tr>';
    try {
        const maintenance = await apiFetch(`/api/devices/${deviceId}/maintenance`);
        tbody.innerHTML = '';
        if (maintenance.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Für dieses Gerät gibt es keine Wartungseinträge.</td></tr>';
            return;
        }
        maintenance.forEach(item => {
            tbody.innerHTML += `
                <tr>
                    <td>${item.event_date}</td>
                    <td>${item.event_type}</td>
                    <td>${item.title}</td>
                    <td>${maintenanceStatusBadges[item.status] || item.status}</td>
                    <td>${item.performed_by || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick="editMaintenance(${item.maintenance_id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMaintenance(${item.maintenance_id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    } catch (error) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Fehler beim Laden der Wartungsdaten.</td></tr>';
        console.error(`Fehler beim Laden der Wartung für Gerät ${deviceId}:`, error);
    }
}

// Modal für "Neuer Eintrag" öffnen
document.getElementById('new-maintenance-btn').addEventListener('click', () => {
    const deviceId = document.getElementById('maintenance-device-select').value;
    if (!deviceId) {
        alert("Bitte zuerst ein Gerät auswählen.");
        return;
    }
    document.getElementById('maintenanceForm').reset();
    document.getElementById('maintenanceId').value = '';
    document.getElementById('maintenanceDeviceId').value = deviceId;
    document.getElementById('maintenanceModalTitle').textContent = 'Neuer Wartungseintrag';
    document.getElementById('maintenance-event_date').value = new Date().toISOString().split('T')[0];
    new bootstrap.Modal(document.getElementById('maintenanceModal')).show();
});

// Modal für "Bearbeiten" füllen und öffnen
async function editMaintenance(id) {
    try {
        const item = await apiFetch(`/api/maintenance/${id}`);
        document.getElementById('maintenanceForm').reset();
        document.getElementById('maintenanceModalTitle').textContent = 'Wartungseintrag bearbeiten';
        document.getElementById('maintenanceId').value = item.maintenance_id;
        document.getElementById('maintenanceDeviceId').value = item.device_id;
        
        // Formularfelder füllen
        document.getElementById('maintenance-event_date').value = item.event_date;
        document.getElementById('maintenance-title').value = item.title;
        document.getElementById('maintenance-event_type').value = item.event_type;
        document.getElementById('maintenance-status').value = item.status;
        document.getElementById('maintenance-performed_by').value = item.performed_by;
        document.getElementById('maintenance-description').value = item.description;
        document.getElementById('maintenance-duration_minutes').value = item.duration_minutes;
        document.getElementById('maintenance-cost_cents').value = item.cost_cents;
        document.getElementById('maintenance-next_due_date').value = item.next_due_date;
        document.getElementById('maintenance-notes').value = item.notes;

        new bootstrap.Modal(document.getElementById('maintenanceModal')).show();
    } catch(error) {
         console.error(`Fehler beim Laden von Wartungseintrag ${id}:`, error);
    }
}

// Formular-Submit-Handler (Neu & Bearbeiten)
document.getElementById('maintenanceForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('maintenanceId').value;
    const deviceId = document.getElementById('maintenanceDeviceId').value;
    const isUpdate = !!id;
    const url = isUpdate ? `/api/maintenance/${id}` : `/api/devices/${deviceId}/maintenance`;
    const method = isUpdate ? 'PUT' : 'POST';

    const body = {
        event_date: document.getElementById('maintenance-event_date').value,
        title: document.getElementById('maintenance-title').value,
        event_type: document.getElementById('maintenance-event_type').value,
        status: document.getElementById('maintenance-status').value,
        performed_by: document.getElementById('maintenance-performed_by').value || null,
        description: document.getElementById('maintenance-description').value || null,
        duration_minutes: document.getElementById('maintenance-duration_minutes').value || null,
        cost_cents: document.getElementById('maintenance-cost_cents').value || null,
        next_due_date: document.getElementById('maintenance-next_due_date').value || null,
        notes: document.getElementById('maintenance-notes').value || null,
    };
    
    try {
        await apiFetch(url, { method, body: JSON.stringify(body) });
        bootstrap.Modal.getInstance(document.getElementById('maintenanceModal')).hide();
        loadMaintenanceForDevice(deviceId); // Tabelle neu laden
    } catch (error) {
        console.error('Fehler beim Speichern des Wartungseintrags:', error);
        alert('Speichern fehlgeschlagen!');
    }
});

// Löschen-Funktion
async function deleteMaintenance(id) {
    if (confirm(`Möchtest du den Wartungseintrag #${id} wirklich löschen?`)) {
         try {
            const deviceId = document.getElementById('maintenance-device-select').value;
            await apiFetch(`/api/maintenance/${id}`, { method: 'DELETE' });
            loadMaintenanceForDevice(deviceId); // Tabelle neu laden
        } catch (error) {
            console.error('Fehler beim Löschen des Eintrags:', error);
            alert('Löschen fehlgeschlagen!');
        }
    }
}

// --- Initialisierung (Erweiterung) ---
document.addEventListener('DOMContentLoaded', () => {
    // ... bestehender Code ...
    
    // Event Listeners für den Stammdaten-Tab
    document.querySelector('#collapseRooms').addEventListener('show.bs.collapse', () => loadMasterData('rooms'));
    document.querySelector('#collapseModels').addEventListener('show.bs.collapse', () => loadMasterData('models_with_details', 'models')); // Spezialroute
    document.querySelector('#collapseDeviceCats').addEventListener('show.bs.collapse', () => loadMasterData('device_categories'));

    // Form Submit Handler
    document.getElementById('roomForm').addEventListener('submit', (e) => handleFormSubmit(e, 'rooms', 'room_id'));
    document.getElementById('deviceCategoryForm').addEventListener('submit', (e) => handleFormSubmit(e, 'device_categories', 'category_id'));
});

// --- Logik für den STAMMDATEN-TAB ---

// Generische Funktion zum Laden und Anzeigen von Stammdaten
async function loadMasterData(endpoint, baseName = null) {
    const resourceName = baseName || endpoint;
    const tbody = document.getElementById(`${resourceName}-table-body`);
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Lade...</td></tr>';

    try {
        const data = await apiFetch(`/api/${endpoint}`);
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Keine Einträge vorhanden.</td></tr>';
            return;
        }

        data.forEach(item => {
            let row = '<tr>';
            // Spalten basierend auf Ressource dynamisch erstellen
// app.html (im <script>-Block)

// --- In der loadMasterData Funktion ---
// Ersetze den "if (resourceName === 'rooms')" Block vollständig mit diesem Code:

if (resourceName === 'rooms') {
    let currentFloor = null; // Variable zum Verfolgen des Stockwerks
    data.forEach((item, index) => {
        // NEU: Visuelle Trennung für jedes Stockwerk
        if (item.floor !== currentFloor) {
            currentFloor = item.floor;
            tbody.innerHTML += `
                <tr class="table-light">
                    <td colspan="5"><strong><i class="bi bi-building"></i> Stockwerk: ${currentFloor === null ? 'Nicht definiert' : currentFloor}</strong></td>
                </tr>
            `;
        }

        // GEÄNDERT: Logik zur Anzeige der Pfeile pro Stockwerk
        const prevItem = data[index - 1];
        const nextItem = data[index + 1];
        
        // "Hoch"-Pfeil anzeigen, wenn es nicht das erste Element ist UND das vorherige im selben Stockwerk liegt
        const showUpArrow = prevItem && prevItem.floor === item.floor;
        // "Runter"-Pfeil anzeigen, wenn es nicht das letzte Element ist UND das nächste im selben Stockwerk liegt
        const showDownArrow = nextItem && nextItem.floor === item.floor;

        const upArrow = showUpArrow ? `<button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="moveRoom(${item.room_id}, 'up')"><i class="bi bi-arrow-up"></i></button>` : '';
        const downArrow = showDownArrow ? `<button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="moveRoom(${item.room_id}, 'down')"><i class="bi bi-arrow-down"></i></button>` : '';

        let row = '<tr>';
        row += `<td>${upArrow} ${downArrow}</td>`;
        row += `<td>${item.room_number}</td><td>${item.room_name}</td><td>${item.floor || '-'}</td>`;
        row += `<td>
                   <button class="btn btn-sm btn-outline-secondary" onclick='editMasterData("rooms", ${JSON.stringify(item)})'><i class="bi bi-pencil"></i></button>
                   <button class="btn btn-sm btn-outline-danger" onclick='deleteMasterData("rooms", "room_id", ${item.room_id})'><i class="bi bi-trash"></i></button>
                </td>`;
        row += '</tr>';
        tbody.innerHTML += row;
    });
} else if (resourceName === 'models') {
                 row += `<td>${item.category_name || '-'}</td><td>${item.type}</td><td>${item.model_number}</td>`;
                 row += `<td>...</td>` // Bearbeiten/Löschen für Modelle ist komplexer, hier vereinfacht
            } else if (resourceName === 'device_categories') {
                row += `<td>${item.category_name}</td><td>${item.description || '-'}</td>`;
                row += `<td>
                           <button class="btn btn-sm btn-outline-secondary" onclick='editMasterData("device_categories", ${JSON.stringify(item)})'><i class="bi bi-pencil"></i></button>
                           <button class="btn btn-sm btn-outline-danger" onclick='deleteMasterData("device_categories", "category_id", ${item.category_id})'><i class="bi bi-trash"></i></button>
                        </td>`;
            }
            row += '</tr>';
            tbody.innerHTML += row;
        });
    } catch (error) {
        console.error(`Fehler beim Laden von ${resourceName}:`, error);
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Laden fehlgeschlagen.</td></tr>`;
    }
}

// Generische Funktion zum Bearbeiten eines Eintrags (füllt das Formular)
function editMasterData(resourceName, item) {
    const formPrefix = resourceName === 'device_categories' ? 'cat' : resourceName.slice(0, -1);
    
    for (const key in item) {
        const input = document.getElementById(`${formPrefix}-${key}`);
        if (input) {
            input.value = item[key];
        }
    }
}

// Generische Funktion zum Löschen
async function deleteMasterData(resourceName, pkField, id) {
    if (!confirm(`Soll der Eintrag #${id} wirklich gelöscht werden?`)) return;
    try {
        await apiFetch(`/api/${resourceName}/${id}`, { method: 'DELETE' });
        loadMasterData(resourceName); // Liste neu laden
    } catch (error) {
        console.error(`Fehler beim Löschen von ${resourceName} #${id}:`, error);
        alert('Löschen fehlgeschlagen! Eventuell bestehen noch Abhängigkeiten zu anderen Daten.');
    }
}

// Generischer Formular-Handler
async function handleFormSubmit(event, resourceName, pkField) {
    event.preventDefault();
    const formPrefix = resourceName === 'device_categories' ? 'cat' : resourceName.slice(0, -1);
    const form = event.target;
    
    const id = form.querySelector(`#${formPrefix}-${pkField}`).value;
    const isUpdate = !!id;
    const url = isUpdate ? `/api/${resourceName}/${id}` : `/api/${resourceName}`;
    const method = isUpdate ? 'PUT' : 'POST';

    const body = {};
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.type !== 'hidden' && input.type !== 'submit') {
            const key = input.id.replace(`${formPrefix}-`, '');
            body[key] = input.value || null;
        }
    });

    try {
        await apiFetch(url, { method, body: JSON.stringify(body) });
        form.reset();
        // ID-Feld explizit leeren
        const idField = form.querySelector(`#${formPrefix}-${pkField}`);
        if (idField) idField.value = '';

        loadMasterData(resourceName);
    } catch (error) {
        console.error(`Fehler beim Speichern von ${resourceName}:`, error);
        alert('Speichern fehlgeschlagen!');
    }
}
    </script>
</body>
</html>